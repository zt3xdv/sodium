function n(n){return"string"!=typeof n?"":n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/`/g,"&#96;")}function e(n){if("string"!=typeof n||!n.trim())return"";try{const e=new URL(n.trim());return["http:","https:"].includes(e.protocol)?e.href:""}catch{return""}}function t(n){for(const e of n)if(e)try{if("https:"!==new URL(e).protocol)return!1}catch{return!1}return!0}function s(n,e){if(!n||!t([n]))return void(e.innerHTML='<span class="material-icons-outlined">person</span>');const s=new Image;s.onload=()=>{e.innerHTML="",e.appendChild(s)},s.onerror=()=>{e.innerHTML='<span class="material-icons-outlined">person</span>'},s.src=n,s.alt="Avatar"}async function a(n){try{await fetch("/api/user/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:localStorage.getItem("username"),password:localStorage.getItem("password"),settings:n})})}catch(n){console.error("Failed to save settings:",n)}}let i=null;async function o(){const e=localStorage.getItem("username"),t=document.getElementById("servers-list");if(t)try{const s=await fetch(`/api/servers?username=${encodeURIComponent(e)}`),a=await s.json();if(0===a.servers.length)return void(t.innerHTML='\n        <div class="empty-state">\n          <span class="material-icons-outlined icon">dns</span>\n          <h3>No Servers</h3>\n          <p>You don\'t have any servers yet. Contact an administrator to get started.</p>\n        </div>\n      ');t.innerHTML=a.servers.map(e=>`\n      <div class="server-card card" data-id="${e.id}">\n        <div class="server-header">\n          <h3>${n(e.name)}</h3>\n          <span class="status status-${e.status||"offline"}">${e.status||"offline"}</span>\n        </div>\n        <div class="server-info">\n          <div class="info-row">\n            <span class="label">Memory</span>\n            <span class="value">${e.limits?.memory||0} MB</span>\n          </div>\n          <div class="info-row">\n            <span class="label">Disk</span>\n            <span class="value">${e.limits?.disk||0} MB</span>\n          </div>\n          <div class="info-row">\n            <span class="label">CPU</span>\n            <span class="value">${e.limits?.cpu||0}%</span>\n          </div>\n          <div class="info-row">\n            <span class="label">Address</span>\n            <span class="value">${e.allocation?.ip}:${e.allocation?.port}</span>\n          </div>\n        </div>\n        <div class="server-actions">\n          <button class="btn btn-success btn-sm" onclick="serverPower('${e.id}', 'start')">Start</button>\n          <button class="btn btn-warning btn-sm" onclick="serverPower('${e.id}', 'restart')">Restart</button>\n          <button class="btn btn-danger btn-sm" onclick="serverPower('${e.id}', 'stop')">Stop</button>\n          <a href="/server/${e.id}" class="btn btn-primary btn-sm">Console</a>\n        </div>\n      </div>\n    `).join("")}catch(n){t.innerHTML='<div class="error">Failed to load servers</div>'}}window.serverPower=async function(n,e){const t=localStorage.getItem("username");try{await fetch(`/api/servers/${n}/power`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,action:e})}),o()}catch(n){alert("Failed to execute power action")}};let r=null;async function l(n){const e=localStorage.getItem("username");try{const t=await fetch(`/api/servers/${n}?username=${encodeURIComponent(e)}`),s=await t.json();if(s.error)return void(document.getElementById("server-name").textContent="Error");const a=s.server,i=s.resources;document.getElementById("server-name").textContent=a.name,document.getElementById("info-address").textContent=`${a.allocation?.ip}:${a.allocation?.port}`,document.getElementById("info-node").textContent=a.node_id?.substring(0,8)||"--",i&&(document.getElementById("res-status").textContent=i.state||"offline",document.getElementById("res-status").className=`value status-${i.state||"offline"}`,document.getElementById("res-cpu").textContent=`${(i.resources?.cpu_absolute||0).toFixed(1)}%`,document.getElementById("res-memory").textContent=m(i.resources?.memory_bytes||0),document.getElementById("res-disk").textContent=m(i.resources?.disk_bytes||0),document.getElementById("res-net-tx").textContent=m(i.resources?.network_tx_bytes||0),document.getElementById("res-net-rx").textContent=m(i.resources?.network_rx_bytes||0))}catch(n){console.error("Failed to load server:",n)}}async function d(n,e){const t=localStorage.getItem("username");try{const s=await fetch(`/api/servers/${n}/power`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,action:e})});s.ok?(p(`[SYSTEM] Power action: ${e}`),l(n)):p(`[ERROR] ${(await s.json()).error}`)}catch(n){p("[ERROR] Failed to execute power action")}}async function c(n){const e=document.getElementById("command-input"),t=e.value.trim();if(!t)return;const s=localStorage.getItem("username");try{const a=await fetch(`/api/servers/${n}/command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s,command:t})});p(`> ${t}`),e.value="",a.ok||p(`[ERROR] ${(await a.json()).error}`)}catch(n){p("[ERROR] Failed to send command")}}function p(n){const e=document.getElementById("console-output"),t=e.querySelector(".console-placeholder");t&&t.remove();const s=document.createElement("div");s.className="console-line",s.textContent=n,e.appendChild(s),e.scrollTop=e.scrollHeight}function m(n){if(0===n)return"0 B";const e=Math.floor(Math.log(n)/Math.log(1024));return parseFloat((n/Math.pow(1024,e)).toFixed(2))+" "+["B","KB","MB","GB"][e]}function u(){r&&(clearInterval(r),r=null)}let v=null;async function g(){const e=document.getElementById("nodes-list");try{const t=await fetch("/api/status/nodes"),s=await t.json(),a=s.nodes.filter(n=>"online"===n.status).length,i=s.nodes.length,o=s.nodes.reduce((n,e)=>n+e.servers,0);if(document.getElementById("nodes-online").textContent=a,document.getElementById("nodes-total").textContent=i,document.getElementById("servers-total").textContent=o,document.getElementById("last-update").textContent=(new Date).toLocaleTimeString(),0===s.nodes.length)return void(e.innerHTML='\n        <div class="empty-state">\n          <span class="material-icons-outlined icon">power_off</span>\n          <h3>No Nodes</h3>\n          <p>No nodes have been configured yet.</p>\n        </div>\n      ');e.innerHTML=s.nodes.map(e=>{const t=e.memory.total>0?e.memory.used/(1024*e.memory.total*1024)*100:0,s=e.disk.total>0?e.disk.used/(1024*e.disk.total*1024)*100:0;return`\n        <div class="node-status-card card ${e.status}">\n          <div class="node-header">\n            <h3>${n(e.name)}</h3>\n            <span class="status-badge status-${e.status}">${e.status}</span>\n          </div>\n          <div class="node-stats">\n            <div class="stat">\n              <span class="label">Servers</span>\n              <span class="value">${e.servers}</span>\n            </div>\n            <div class="stat">\n              <span class="label">Memory</span>\n              <div class="progress-bar">\n                <div class="progress" style="width: ${Math.min(t,100)}%"></div>\n              </div>\n              <span class="value">${t.toFixed(1)}%</span>\n            </div>\n            <div class="stat">\n              <span class="label">Disk</span>\n              <div class="progress-bar">\n                <div class="progress" style="width: ${Math.min(s,100)}%"></div>\n              </div>\n              <span class="value">${s.toFixed(1)}%</span>\n            </div>\n          </div>\n        </div>\n      `}).join("")}catch(n){e.innerHTML='<div class="error">Failed to load status</div>'}}let b="nodes";async function h(e){const t=document.getElementById("admin-content"),s=localStorage.getItem("username");switch(t.innerHTML='<div class="loading-spinner"></div>',e){case"nodes":await async function(e,t){try{const s=await fetch(`/api/admin/nodes?username=${encodeURIComponent(t)}`),a=await s.json();e.innerHTML=`\n      <div class="admin-section">\n        <div class="section-header">\n          <h2>Nodes</h2>\n          <button class="btn btn-primary" id="add-node-btn"><span class="material-icons-outlined">add</span> Add Node</button>\n        </div>\n        \n        <div id="node-form" class="card form-card" style="display:none;">\n          <h3>Create Node</h3>\n          <form id="create-node-form">\n            <div class="form-group">\n              <label>Name</label>\n              <input type="text" name="name" required />\n            </div>\n            <div class="form-row">\n              <div class="form-group">\n                <label>FQDN</label>\n                <input type="text" name="fqdn" placeholder="node.example.com" required />\n              </div>\n              <div class="form-group">\n                <label>Scheme</label>\n                <select name="scheme">\n                  <option value="https">HTTPS</option>\n                  <option value="http">HTTP</option>\n                </select>\n              </div>\n            </div>\n            <div class="form-row">\n              <div class="form-group">\n                <label>Memory (MB)</label>\n                <input type="number" name="memory" value="8192" required />\n              </div>\n              <div class="form-group">\n                <label>Disk (MB)</label>\n                <input type="number" name="disk" value="51200" required />\n              </div>\n            </div>\n            <div class="form-row">\n              <div class="form-group">\n                <label>Daemon Port</label>\n                <input type="number" name="daemon_port" value="8080" required />\n              </div>\n              <div class="form-group">\n                <label>SFTP Port</label>\n                <input type="number" name="daemon_sftp_port" value="2022" required />\n              </div>\n            </div>\n            <div class="form-group">\n              <label>Location</label>\n              <select name="location_id" id="node-location"></select>\n            </div>\n            <div class="form-actions">\n              <button type="submit" class="btn btn-primary">Create</button>\n              <button type="button" class="btn btn-ghost" id="cancel-node">Cancel</button>\n            </div>\n          </form>\n        </div>\n        \n        <div class="admin-table">\n          <table>\n            <thead>\n              <tr>\n                <th>Name</th>\n                <th>FQDN</th>\n                <th>Memory</th>\n                <th>Disk</th>\n                <th>Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${0===a.nodes.length?'<tr><td colspan="5" class="empty">No nodes</td></tr>':""}\n              ${a.nodes.map(e=>`\n                <tr>\n                  <td>${n(e.name)}</td>\n                  <td>${n(e.fqdn)}</td>\n                  <td>${e.memory} MB</td>\n                  <td>${e.disk} MB</td>\n                  <td>\n                    <button class="btn btn-sm btn-ghost" onclick="editNode('${e.id}')">Edit</button>\n                    <button class="btn btn-sm btn-ghost" onclick="showNodeConfig('${e.id}')">Config</button>\n                    <button class="btn btn-sm btn-ghost" onclick="showDeployCommand('${e.id}')">Deploy</button>\n                    <button class="btn btn-sm btn-danger" onclick="deleteNode('${e.id}')">Delete</button>\n                  </td>\n                </tr>\n              `).join("")}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    `;const i=await fetch("/api/admin/locations"),o=await i.json();document.getElementById("node-location").innerHTML=o.locations.map(e=>`<option value="${e.id}">${n(e.long)} (${n(e.short)})</option>`).join(""),document.getElementById("add-node-btn").onclick=()=>{document.getElementById("node-form").style.display="block"},document.getElementById("cancel-node").onclick=()=>{document.getElementById("node-form").style.display="none"},document.getElementById("create-node-form").onsubmit=async n=>{n.preventDefault();const e=new FormData(n.target),s=Object.fromEntries(e);await fetch("/api/admin/nodes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,node:s})}),h("nodes")}}catch(n){e.innerHTML='<div class="error">Failed to load nodes</div>'}}(t,s);break;case"servers":await async function(e,t){try{const s=await fetch(`/api/admin/servers?username=${encodeURIComponent(t)}`),a=await s.json();e.innerHTML=`\n      <div class="admin-section">\n        <div class="section-header">\n          <h2>Servers</h2>\n          <button class="btn btn-primary" id="add-server-btn"><span class="material-icons-outlined">add</span> Create Server</button>\n        </div>\n        \n        <div id="server-form" class="card form-card" style="display:none;">\n          <h3>Create Server</h3>\n          <form id="create-server-form">\n            <div class="form-group">\n              <label>Name</label>\n              <input type="text" name="name" required />\n            </div>\n            <div class="form-row">\n              <div class="form-group">\n                <label>Owner (User ID)</label>\n                <select name="user_id" id="server-user"></select>\n              </div>\n              <div class="form-group">\n                <label>Node</label>\n                <select name="node_id" id="server-node"></select>\n              </div>\n            </div>\n            <div class="form-group">\n              <label>Egg</label>\n              <select name="egg_id" id="server-egg"></select>\n            </div>\n            <div class="form-row">\n              <div class="form-group">\n                <label>Memory (MB)</label>\n                <input type="number" name="memory" value="1024" required />\n              </div>\n              <div class="form-group">\n                <label>Disk (MB)</label>\n                <input type="number" name="disk" value="5120" required />\n              </div>\n              <div class="form-group">\n                <label>CPU (%)</label>\n                <input type="number" name="cpu" value="100" required />\n              </div>\n            </div>\n            <div class="form-row">\n              <div class="form-group">\n                <label>Allocation IP</label>\n                <input type="text" name="allocation_ip" value="0.0.0.0" />\n              </div>\n              <div class="form-group">\n                <label>Allocation Port</label>\n                <input type="number" name="allocation_port" value="25565" />\n              </div>\n            </div>\n            <div class="form-actions">\n              <button type="submit" class="btn btn-primary">Create</button>\n              <button type="button" class="btn btn-ghost" id="cancel-server">Cancel</button>\n            </div>\n          </form>\n        </div>\n        \n        <div class="admin-table">\n          <table>\n            <thead>\n              <tr>\n                <th>Name</th>\n                <th>Owner</th>\n                <th>Resources</th>\n                <th>Status</th>\n                <th>Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${0===a.servers.length?'<tr><td colspan="5" class="empty">No servers</td></tr>':""}\n              ${a.servers.map(e=>`\n                <tr>\n                  <td>${n(e.name)}</td>\n                  <td>${e.user_id?.substring(0,8)||"--"}</td>\n                  <td>${e.limits?.memory||0}MB / ${e.limits?.disk||0}MB / ${e.limits?.cpu||0}%</td>\n                  <td><span class="status-badge status-${e.status}">${e.status}</span></td>\n                  <td>\n                    <button class="btn btn-sm btn-danger" onclick="deleteServer('${e.id}')">Delete</button>\n                  </td>\n                </tr>\n              `).join("")}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    `;const i=await fetch(`/api/admin/users?username=${encodeURIComponent(t)}`),o=await i.json();document.getElementById("server-user").innerHTML=o.users.map(e=>`<option value="${e.id}">${n(e.username)}</option>`).join("");const r=await fetch(`/api/admin/nodes?username=${encodeURIComponent(t)}`),l=await r.json();document.getElementById("server-node").innerHTML=l.nodes.map(e=>`<option value="${e.id}">${n(e.name)}</option>`).join("");const d=await fetch("/api/admin/eggs"),c=await d.json();document.getElementById("server-egg").innerHTML=c.eggs.map(e=>`<option value="${e.id}">${n(e.name)}</option>`).join(""),document.getElementById("add-server-btn").onclick=()=>{document.getElementById("server-form").style.display="block"},document.getElementById("cancel-server").onclick=()=>{document.getElementById("server-form").style.display="none"},document.getElementById("create-server-form").onsubmit=async n=>{n.preventDefault();const e=new FormData(n.target),s=Object.fromEntries(e);await fetch("/api/admin/servers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,server:s})}),h("servers")}}catch(n){e.innerHTML='<div class="error">Failed to load servers</div>'}}(t,s);break;case"users":await async function(e,t){try{const s=await fetch(`/api/admin/users?username=${encodeURIComponent(t)}`),a=await s.json();e.innerHTML=`\n      <div class="admin-section">\n        <div class="section-header">\n          <h2>Users</h2>\n        </div>\n        \n        <div class="admin-table">\n          <table>\n            <thead>\n              <tr>\n                <th>Username</th>\n                <th>Display Name</th>\n                <th>Admin</th>\n                <th>Limits</th>\n                <th>Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${a.users.map(e=>`\n                <tr>\n                  <td>${n(e.username)}</td>\n                  <td>${n(e.displayName||e.username)}</td>\n                  <td>${e.isAdmin?"✓":"✗"}</td>\n                  <td>${e.limits?`${e.limits.servers} servers, ${e.limits.memory}MB`:"Default"}</td>\n                  <td>\n                    <button class="btn btn-sm btn-ghost" onclick="toggleAdmin('${e.id}', ${!e.isAdmin})">${e.isAdmin?"Remove Admin":"Make Admin"}</button>\n                    <button class="btn btn-sm btn-ghost" onclick="editUserLimits('${e.id}')">Edit Limits</button>\n                  </td>\n                </tr>\n              `).join("")}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    `}catch(n){e.innerHTML='<div class="error">Failed to load users</div>'}}(t,s);break;case"nests":await async function(e,t){try{const s=await fetch("/api/admin/nests"),a=await s.json();e.innerHTML=`\n      <div class="admin-section">\n        <div class="section-header">\n          <h2>Nests & Eggs</h2>\n          <div>\n            <button class="btn btn-ghost" id="add-nest-btn"><span class="material-icons-outlined">add</span> Add Nest</button>\n            <button class="btn btn-primary" id="import-egg-btn"><span class="material-icons-outlined">upload</span> Import Egg</button>\n          </div>\n        </div>\n        \n        <div id="import-egg-form" class="card form-card" style="display:none;">\n          <h3>Import Pterodactyl Egg</h3>\n          <form id="egg-import-form">\n            <div class="form-group">\n              <label>Egg JSON</label>\n              <textarea name="eggJson" rows="10" placeholder="Paste egg JSON here..."></textarea>\n            </div>\n            <div class="form-actions">\n              <button type="submit" class="btn btn-primary">Import</button>\n              <button type="button" class="btn btn-ghost" id="cancel-import">Cancel</button>\n            </div>\n          </form>\n        </div>\n        \n        <div class="nests-grid">\n          ${a.nests.map(e=>`\n            <div class="nest-card card">\n              <h3>${n(e.name)}</h3>\n              <p>${n(e.description)}</p>\n              <div class="eggs-list">\n                <h4>Eggs (${e.eggs?.length||0})</h4>\n                ${(e.eggs||[]).map(e=>`\n                  <div class="egg-item">\n                    <span class="egg-name">${n(e.name)}</span>\n                    <span class="egg-image">${n(e.docker_image?.split("/").pop()||"")}</span>\n                  </div>\n                `).join("")||'<div class="empty">No eggs</div>'}\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `,document.getElementById("add-nest-btn").onclick=async()=>{const n=prompt("Nest name:");if(!n)return;const e=prompt("Description:")||"";await fetch("/api/admin/nests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,nest:{name:n,description:e}})}),h("nests")},document.getElementById("import-egg-btn").onclick=()=>{document.getElementById("import-egg-form").style.display="block"},document.getElementById("cancel-import").onclick=()=>{document.getElementById("import-egg-form").style.display="none"},document.getElementById("egg-import-form").onsubmit=async n=>{n.preventDefault();const e=new FormData(n.target);(await fetch("/api/admin/eggs/import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,eggJson:e.get("eggJson")})})).ok?h("nests"):alert("Failed to import egg")}}catch(n){e.innerHTML='<div class="error">Failed to load nests</div>'}}(t,s);break;case"locations":await async function(e,t){try{const s=await fetch("/api/admin/locations"),a=await s.json();e.innerHTML=`\n      <div class="admin-section">\n        <div class="section-header">\n          <h2>Locations</h2>\n          <button class="btn btn-primary" id="add-location-btn"><span class="material-icons-outlined">add</span> Add Location</button>\n        </div>\n        \n        <div class="admin-table">\n          <table>\n            <thead>\n              <tr>\n                <th>ID</th>\n                <th>Short</th>\n                <th>Long</th>\n                <th>Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${a.locations.map(e=>`\n                <tr>\n                  <td>${e.id}</td>\n                  <td>${n(e.short)}</td>\n                  <td>${n(e.long)}</td>\n                  <td>\n                    <button class="btn btn-sm btn-danger" onclick="deleteLocation('${e.id}')">Delete</button>\n                  </td>\n                </tr>\n              `).join("")}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    `,document.getElementById("add-location-btn").onclick=async()=>{const n=prompt("Short code (e.g., us, eu):");if(!n)return;const e=prompt("Full name:")||n;await fetch("/api/admin/locations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,location:{short:n,long:e}})}),h("locations")}}catch(n){e.innerHTML='<div class="error">Failed to load locations</div>'}}(t,s)}}function y(n,e=0){let t="";const s="  ".repeat(e);for(const[a,i]of Object.entries(n))null==i?t+=`${s}${a}: null\n`:"object"!=typeof i||Array.isArray(i)?Array.isArray(i)?(t+=`${s}${a}:\n`,i.forEach(n=>{t+="object"==typeof n?`${s}  -\n${y(n,e+2)}`:`${s}  - ${n}\n`})):t+="string"==typeof i?`${s}${a}: "${i}"\n`:`${s}${a}: ${i}\n`:t+=`${s}${a}:\n${y(i,e+1)}`;return t}window.editNode=async function(e){const t=localStorage.getItem("username");try{const s=await fetch(`/api/admin/nodes?username=${encodeURIComponent(t)}`),a=(await s.json()).nodes.find(n=>n.id===e);if(!a)return alert("Node not found");const i=await fetch("/api/admin/locations"),o=await i.json(),r=document.createElement("div");r.className="modal active",r.innerHTML=`\n      <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>\n      <div class="modal-content modal-large">\n        <h2>Edit Node</h2>\n        <form id="edit-node-form">\n          <div class="form-group">\n            <label>Name</label>\n            <input type="text" name="name" value="${n(a.name)}" required />\n          </div>\n          <div class="form-group">\n            <label>Description</label>\n            <input type="text" name="description" value="${n(a.description||"")}" />\n          </div>\n          <div class="form-row">\n            <div class="form-group">\n              <label>FQDN</label>\n              <input type="text" name="fqdn" value="${n(a.fqdn)}" required />\n            </div>\n            <div class="form-group">\n              <label>Scheme</label>\n              <select name="scheme">\n                <option value="https" ${"https"===a.scheme?"selected":""}>HTTPS</option>\n                <option value="http" ${"http"===a.scheme?"selected":""}>HTTP</option>\n              </select>\n            </div>\n          </div>\n          <div class="form-row">\n            <div class="form-group">\n              <label>Memory (MB)</label>\n              <input type="number" name="memory" value="${a.memory}" required />\n            </div>\n            <div class="form-group">\n              <label>Disk (MB)</label>\n              <input type="number" name="disk" value="${a.disk}" required />\n            </div>\n          </div>\n          <div class="form-row">\n            <div class="form-group">\n              <label>Daemon Port</label>\n              <input type="number" name="daemon_port" value="${a.daemon_port}" required />\n            </div>\n            <div class="form-group">\n              <label>SFTP Port</label>\n              <input type="number" name="daemon_sftp_port" value="${a.daemon_sftp_port}" required />\n            </div>\n          </div>\n          <div class="form-row">\n            <div class="form-group">\n              <label>Upload Size (MB)</label>\n              <input type="number" name="upload_size" value="${a.upload_size||100}" />\n            </div>\n            <div class="form-group">\n              <label>Location</label>\n              <select name="location_id">\n                ${o.locations.map(e=>`<option value="${e.id}" ${e.id===a.location_id?"selected":""}>${n(e.long)}</option>`).join("")}\n              </select>\n            </div>\n          </div>\n          <div class="form-row">\n            <div class="form-group">\n              <label><input type="checkbox" name="behind_proxy" ${a.behind_proxy?"checked":""} /> Behind Proxy</label>\n            </div>\n            <div class="form-group">\n              <label><input type="checkbox" name="maintenance_mode" ${a.maintenance_mode?"checked":""} /> Maintenance Mode</label>\n            </div>\n          </div>\n          <div class="modal-actions">\n            <button type="submit" class="btn btn-primary">Save</button>\n            <button type="button" class="btn btn-ghost" onclick="this.closest('.modal').remove()">Cancel</button>\n          </div>\n        </form>\n      </div>\n    `,document.body.appendChild(r),document.getElementById("edit-node-form").onsubmit=async n=>{n.preventDefault();const s=new FormData(n.target),a=Object.fromEntries(s);a.behind_proxy="on"===s.get("behind_proxy"),a.maintenance_mode="on"===s.get("maintenance_mode"),await fetch(`/api/admin/nodes/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,node:a})}),r.remove(),h("nodes")}}catch(n){alert("Failed to load node: "+n.message)}},window.showDeployCommand=async function(e){const t=localStorage.getItem("username");try{const s=await fetch(`/api/admin/nodes/${e}/deploy?username=${encodeURIComponent(t)}`),a=await s.json();if(a.error)return void alert(a.error);const i=document.createElement("div");i.className="modal active",i.innerHTML=`\n      <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>\n      <div class="modal-content">\n        <h2>Deploy Command</h2>\n        <p>Run this command on your node to configure Wings:</p>\n        <pre class="config-output" style="white-space:pre-wrap;word-break:break-all;">${n(a.command)}</pre>\n        <div class="modal-actions">\n          <button class="btn btn-ghost" onclick="navigator.clipboard.writeText(this.closest('.modal').querySelector('.config-output').textContent);this.textContent='Copied!'">Copy</button>\n          <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>\n        </div>\n      </div>\n    `,document.body.appendChild(i)}catch(n){alert("Failed to load deploy command: "+n.message)}},window.showNodeConfig=async function(e){const t=localStorage.getItem("username");try{const s=await fetch(`/api/admin/nodes/${e}/config?username=${encodeURIComponent(t)}`),a=await s.json();if(a.error)return void alert(a.error);const i=y(a.config),o=document.createElement("div");o.className="modal active",o.innerHTML=`\n      <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>\n      <div class="modal-content">\n        <h2>Wings Configuration</h2>\n        <p>Copy this configuration to <code>/etc/pterodactyl/config.yml</code> on your node:</p>\n        <pre class="config-output">${n(i)}</pre>\n        <div class="modal-actions">\n          <button class="btn btn-ghost" onclick="navigator.clipboard.writeText(this.closest('.modal').querySelector('.config-output').textContent);this.textContent='Copied!'">Copy</button>\n          <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>\n        </div>\n      </div>\n    `,document.body.appendChild(o)}catch(n){alert("Failed to load config: "+n.message)}},window.deleteNode=async function(n){if(!confirm("Are you sure? This cannot be undone."))return;const e=localStorage.getItem("username");try{await fetch(`/api/admin/nodes/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e})}),h("nodes")}catch(n){alert("Failed to delete node")}},window.deleteServer=async function(n){if(!confirm("Are you sure? This will delete the server from the node."))return;const e=localStorage.getItem("username");try{await fetch(`/api/admin/servers/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e})}),h("servers")}catch(n){alert("Failed to delete server")}},window.toggleAdmin=async function(n,e){const t=localStorage.getItem("username");await fetch(`/api/admin/users/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,updates:{isAdmin:e}})}),h("users")},window.editUserLimits=async function(n){const e={servers:parseInt(prompt("Max servers:","2"))||2,memory:parseInt(prompt("Max memory (MB):","2048"))||2048,disk:parseInt(prompt("Max disk (MB):","10240"))||10240,cpu:parseInt(prompt("Max CPU (%):","200"))||200},t=localStorage.getItem("username");await fetch(`/api/admin/users/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,updates:{limits:e}})}),h("users")},window.deleteLocation=async function(n){if(!confirm("Delete this location?"))return;const e=localStorage.getItem("username");await fetch(`/api/admin/locations/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e})}),h("locations")};const f={"/":{redirect:"/auth"},"/auth":{render:function(){const n=document.getElementById("app");n.className="auth-page",n.innerHTML='\n    <div class="auth-container">\n      <div class="auth-card">\n        <div class="auth-header">\n          <div class="logo">\n            <span class="material-icons-outlined">bolt</span>\n            <span class="logo-text">Sodium</span>\n          </div>\n          <p class="auth-subtitle">Welcome back</p>\n        </div>\n        \n        <div class="auth-tabs">\n          <button class="tab-btn active" data-tab="login">Sign In</button>\n          <button class="tab-btn" data-tab="register">Sign Up</button>\n        </div>\n        \n        <form id="login-form" class="auth-form active">\n          <div class="form-group">\n            <label for="login-username">Username</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">person</span>\n              <input type="text" id="login-username" name="username" placeholder="Enter your username" required>\n            </div>\n          </div>\n          \n          <div class="form-group">\n            <label for="login-password">Password</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">lock</span>\n              <input type="password" id="login-password" name="password" placeholder="Enter your password" required>\n            </div>\n          </div>\n          \n          <div class="error-message" id="login-error"></div>\n          \n          <button type="submit" class="btn btn-primary btn-full">\n            <span>Sign In</span>\n            <span class="material-icons-outlined">arrow_forward</span>\n          </button>\n        </form>\n        \n        <form id="register-form" class="auth-form">\n          <div class="form-group">\n            <label for="register-username">Username</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">person</span>\n              <input type="text" id="register-username" name="username" placeholder="Choose a username" required minlength="3" maxlength="20">\n            </div>\n            <small class="form-hint">3-20 characters</small>\n          </div>\n          \n          <div class="form-group">\n            <label for="register-password">Password</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">lock</span>\n              <input type="password" id="register-password" name="password" placeholder="Create a password" required minlength="6">\n            </div>\n            <small class="form-hint">Minimum 6 characters</small>\n          </div>\n          \n          <div class="form-group">\n            <label for="register-confirm">Confirm Password</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">lock</span>\n              <input type="password" id="register-confirm" name="confirm" placeholder="Confirm your password" required>\n            </div>\n          </div>\n          \n          <div class="error-message" id="register-error"></div>\n          \n          <button type="submit" class="btn btn-primary btn-full">\n            <span>Create Account</span>\n            <span class="material-icons-outlined">arrow_forward</span>\n          </button>\n        </form>\n      </div>\n    </div>\n  ';const e=n.querySelectorAll(".tab-btn"),t=n.querySelector("#login-form"),s=n.querySelector("#register-form");e.forEach(n=>{n.addEventListener("click",()=>{e.forEach(n=>n.classList.remove("active")),n.classList.add("active"),"login"===n.dataset.tab?(t.classList.add("active"),s.classList.remove("active")):(s.classList.add("active"),t.classList.remove("active"))})}),t.addEventListener("submit",async n=>{n.preventDefault();const e=t.querySelector("#login-username").value,s=t.querySelector("#login-password").value,a=t.querySelector("#login-error"),i=t.querySelector('button[type="submit"]');i.disabled=!0,i.innerHTML='<span class="material-icons-outlined spinning">sync</span>';try{const n=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:s})}),t=await n.json();if(t.error)return a.textContent=t.error,a.style.display="block",i.disabled=!1,void(i.innerHTML='<span>Sign In</span><span class="material-icons-outlined">arrow_forward</span>');localStorage.setItem("loggedIn","true"),localStorage.setItem("username",t.user.username),localStorage.setItem("password",s),k("/dashboard")}catch(n){a.textContent="Connection error. Please try again.",a.style.display="block",i.disabled=!1,i.innerHTML='<span>Sign In</span><span class="material-icons-outlined">arrow_forward</span>'}}),s.addEventListener("submit",async n=>{n.preventDefault();const e=s.querySelector("#register-username").value,t=s.querySelector("#register-password").value,a=s.querySelector("#register-confirm").value,i=s.querySelector("#register-error"),o=s.querySelector('button[type="submit"]');if(t!==a)return i.textContent="Passwords do not match",void(i.style.display="block");o.disabled=!0,o.innerHTML='<span class="material-icons-outlined spinning">sync</span>';try{const n=await fetch("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}),s=await n.json();if(s.error)return i.textContent=s.error,i.style.display="block",o.disabled=!1,void(o.innerHTML='<span>Create Account</span><span class="material-icons-outlined">arrow_forward</span>');localStorage.setItem("loggedIn","true"),localStorage.setItem("username",s.user.username),localStorage.setItem("password",t),k("/dashboard")}catch(n){i.textContent="Connection error. Please try again.",i.style.display="block",o.disabled=!1,o.innerHTML='<span>Create Account</span><span class="material-icons-outlined">arrow_forward</span>'}})},options:{title:"Sign In",sidebar:!1}},"/dashboard":{render:function(){const n=document.getElementById("app");n.className="dashboard-page";const e=localStorage.getItem("displayName")||localStorage.getItem("username"),t=localStorage.getItem("username"),s=(new Date).getHours();let a="Good evening";s<12?a="Good morning":s<18&&(a="Good afternoon"),n.innerHTML=`\n    <div class="dashboard-container">\n      <header class="dashboard-header">\n        <div class="greeting">\n          <h1>${a}, <span class="highlight">${e}</span></h1>\n          <p>Welcome to your dashboard</p>\n        </div>\n      </header>\n      \n      <div class="stats-grid">\n        <div class="stat-card">\n          <div class="stat-icon">\n            <span class="material-icons-outlined">person</span>\n          </div>\n          <div class="stat-content">\n            <span class="stat-value">@${t}</span>\n            <span class="stat-label">Your Username</span>\n          </div>\n        </div>\n        \n        <div class="stat-card">\n          <div class="stat-icon">\n            <span class="material-icons-outlined">calendar_today</span>\n          </div>\n          <div class="stat-content">\n            <span class="stat-value">${(new Date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}</span>\n            <span class="stat-label">Today's Date</span>\n          </div>\n        </div>\n        \n        <div class="stat-card">\n          <div class="stat-icon">\n            <span class="material-icons-outlined">schedule</span>\n          </div>\n          <div class="stat-content">\n            <span class="stat-value" id="current-time">${(new Date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}</span>\n            <span class="stat-label">Current Time</span>\n          </div>\n        </div>\n        \n        <div class="stat-card">\n          <div class="stat-icon">\n            <span class="material-icons-outlined">verified</span>\n          </div>\n          <div class="stat-content">\n            <span class="stat-value">Active</span>\n            <span class="stat-label">Account Status</span>\n          </div>\n        </div>\n      </div>\n      \n      <div class="quick-actions">\n        <h2>Quick Actions</h2>\n        <div class="actions-grid">\n          <a href="/profile" class="action-card">\n            <span class="material-icons-outlined">edit</span>\n            <span>Edit Profile</span>\n          </a>\n          <a href="/settings" class="action-card">\n            <span class="material-icons-outlined">settings</span>\n            <span>Settings</span>\n          </a>\n        </div>\n      </div>\n      \n      <div class="activity-section">\n        <h2>Recent Activity</h2>\n        <div class="activity-list">\n          <div class="activity-item">\n            <span class="material-icons-outlined">login</span>\n            <div class="activity-content">\n              <span class="activity-title">Signed in successfully</span>\n              <span class="activity-time">Just now</span>\n            </div>\n          </div>\n          <div class="activity-item">\n            <span class="material-icons-outlined">check_circle</span>\n            <div class="activity-content">\n              <span class="activity-title">Account created</span>\n              <span class="activity-time">Recently</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;const i=n.querySelector("#current-time"),o=setInterval(()=>{document.getElementById("current-time")?i.textContent=(new Date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):clearInterval(o)},1e3)},options:{title:"Dashboard",auth:!0,sidebar:!0}},"/servers":{render:function(){const n=document.getElementById("app");JSON.parse(localStorage.getItem("user")||"{}"),n.innerHTML='\n    <div class="servers-page">\n      <div class="page-header">\n        <h1>My Servers</h1>\n      </div>\n      \n      <div class="resource-limits card">\n        <h3>Resource Usage</h3>\n        <div class="limits-grid" id="limits-display">\n          <div class="limit-item">\n            <span class="label">Loading...</span>\n          </div>\n        </div>\n      </div>\n      \n      <div class="servers-grid" id="servers-list">\n        <div class="loading-spinner"></div>\n      </div>\n    </div>\n  ',o(),async function(){const n=localStorage.getItem("username");try{const e=await fetch(`/api/user/limits?username=${encodeURIComponent(n)}`),t=await e.json(),s=document.getElementById("limits-display");if(!s)return;s.innerHTML=`\n      <div class="limit-item">\n        <span class="label">Servers</span>\n        <div class="progress-bar">\n          <div class="progress" style="width: ${t.used.servers/t.limits.servers*100}%"></div>\n        </div>\n        <span class="value">${t.used.servers} / ${t.limits.servers}</span>\n      </div>\n      <div class="limit-item">\n        <span class="label">Memory</span>\n        <div class="progress-bar">\n          <div class="progress" style="width: ${t.used.memory/t.limits.memory*100}%"></div>\n        </div>\n        <span class="value">${t.used.memory} / ${t.limits.memory} MB</span>\n      </div>\n      <div class="limit-item">\n        <span class="label">Disk</span>\n        <div class="progress-bar">\n          <div class="progress" style="width: ${t.used.disk/t.limits.disk*100}%"></div>\n        </div>\n        <span class="value">${t.used.disk} / ${t.limits.disk} MB</span>\n      </div>\n      <div class="limit-item">\n        <span class="label">CPU</span>\n        <div class="progress-bar">\n          <div class="progress" style="width: ${t.used.cpu/t.limits.cpu*100}%"></div>\n        </div>\n        <span class="value">${t.used.cpu} / ${t.limits.cpu}%</span>\n      </div>\n    `}catch(n){console.error("Failed to load limits:",n)}}(),i=setInterval(o,1e4)},cleanup:function(){i&&(clearInterval(i),i=null)},options:{title:"Servers",auth:!0,sidebar:!0}},"/status":{render:function(){document.getElementById("app").innerHTML='\n    <div class="status-page">\n      <div class="status-header">\n        <span class="material-icons-outlined header-icon">monitor_heart</span>\n        <h1>System Status</h1>\n        <p>Real-time status of all nodes</p>\n      </div>\n      \n      <div class="status-summary" id="status-summary">\n        <div class="summary-card">\n          <span class="number" id="nodes-online">-</span>\n          <span class="label">Nodes Online</span>\n        </div>\n        <div class="summary-card">\n          <span class="number" id="nodes-total">-</span>\n          <span class="label">Total Nodes</span>\n        </div>\n        <div class="summary-card">\n          <span class="number" id="servers-total">-</span>\n          <span class="label">Total Servers</span>\n        </div>\n      </div>\n      \n      <div class="nodes-status-grid" id="nodes-list">\n        <div class="loading-spinner"></div>\n      </div>\n      \n      <div class="status-footer">\n        <p>Last updated: <span id="last-update">--</span></p>\n      </div>\n    </div>\n  ',g(),v=setInterval(g,3e4)},cleanup:function(){v&&(clearInterval(v),v=null)},options:{title:"Status",sidebar:!1}},"/admin":{render:async function(){const n=document.getElementById("app"),e=localStorage.getItem("username"),t=localStorage.getItem("password");n.innerHTML='<div class="loading-spinner"></div>';try{const s=await fetch(`/api/auth/me?username=${encodeURIComponent(e)}&password=${encodeURIComponent(t)}`),a=await s.json();if(!a.user?.isAdmin)return void(n.innerHTML='\n        <div class="error-page">\n          <h1>403</h1>\n          <p>Access Denied</p>\n          <a href="/dashboard" class="btn btn-primary">Go to Dashboard</a>\n        </div>\n      ')}catch(e){return void(n.innerHTML='<div class="error">Failed to verify permissions</div>')}n.innerHTML='\n    <div class="admin-page">\n      <div class="page-header">\n        <h1>Admin Panel</h1>\n      </div>\n      \n      <div class="admin-tabs">\n        <button class="tab-btn active" data-tab="nodes">Nodes</button>\n        <button class="tab-btn" data-tab="servers">Servers</button>\n        <button class="tab-btn" data-tab="users">Users</button>\n        <button class="tab-btn" data-tab="nests">Nests & Eggs</button>\n        <button class="tab-btn" data-tab="locations">Locations</button>\n      </div>\n      \n      <div class="admin-content" id="admin-content">\n        <div class="loading-spinner"></div>\n      </div>\n    </div>\n  ',document.querySelectorAll(".tab-btn").forEach(n=>{n.onclick=()=>{document.querySelectorAll(".tab-btn").forEach(n=>n.classList.remove("active")),n.classList.add("active"),b=n.dataset.tab,h(b)}}),h("nodes")},cleanup:function(){},options:{title:"Admin",auth:!0,sidebar:!0}},"/profile":{render:function(){const e=document.getElementById("app");e.className="profile-page";const a=localStorage.getItem("username"),i=localStorage.getItem("displayName")||a;e.innerHTML=`\n    <div class="profile-container">\n      <div class="profile-header">\n        <h1>Profile</h1>\n        <p>Manage your public profile information</p>\n      </div>\n      \n      <div class="profile-content">\n        <div class="profile-card">\n          <div class="avatar-section">\n            <div class="avatar" id="avatar-preview">\n              <span class="material-icons-outlined">person</span>\n            </div>\n            <div class="avatar-info">\n              <h3 id="profile-display-name">${n(i)}</h3>\n              <span class="username">@${n(a)}</span>\n            </div>\n          </div>\n        </div>\n        \n        <form id="profile-form" class="profile-form">\n          <div class="form-section">\n            <h3>Basic Information</h3>\n            \n            <div class="form-group">\n              <label for="avatar-url">Profile Picture URL</label>\n              <div class="input-wrapper">\n                <span class="material-icons-outlined">image</span>\n                <input type="url" id="avatar-url" name="avatar" placeholder="https://example.com/avatar.png">\n              </div>\n              <small class="form-hint">Use a direct image URL (https only)</small>\n            </div>\n            \n            <div class="form-group">\n              <label for="display-name">Display Name</label>\n              <div class="input-wrapper">\n                <span class="material-icons-outlined">badge</span>\n                <input type="text" id="display-name" name="displayName" value="${n(i)}" maxlength="50" placeholder="Your display name">\n              </div>\n              <small class="form-hint">This is how others will see you</small>\n            </div>\n            \n            <div class="form-group">\n              <label for="bio">Bio</label>\n              <div class="textarea-wrapper">\n                <textarea id="bio" name="bio" maxlength="500" placeholder="Tell us about yourself..." rows="4"></textarea>\n              </div>\n              <small class="form-hint"><span id="bio-count">0</span>/500 characters</small>\n            </div>\n          </div>\n          \n          <div class="form-section">\n            <h3>Social Links</h3>\n            <p class="section-description">These will be visible on your public profile</p>\n            \n            <div class="form-group">\n              <label for="link-website">Website</label>\n              <div class="input-wrapper">\n                <span class="material-icons-outlined">language</span>\n                <input type="url" id="link-website" name="website" placeholder="https://yourwebsite.com">\n              </div>\n            </div>\n            \n            <div class="form-group">\n              <label for="link-twitter">Twitter / X</label>\n              <div class="input-wrapper">\n                <span class="material-icons-outlined">alternate_email</span>\n                <input type="url" id="link-twitter" name="twitter" placeholder="https://twitter.com/username">\n              </div>\n            </div>\n            \n            <div class="form-group">\n              <label for="link-github">GitHub</label>\n              <div class="input-wrapper">\n                <span class="material-icons-outlined">code</span>\n                <input type="url" id="link-github" name="github" placeholder="https://github.com/username">\n              </div>\n            </div>\n            \n            <div class="form-group">\n              <label for="link-discord">Discord</label>\n              <div class="input-wrapper">\n                <span class="material-icons-outlined">chat</span>\n                <input type="url" id="link-discord" name="discord" placeholder="https://discord.gg/invite">\n              </div>\n            </div>\n            \n            <div class="form-group">\n              <label for="link-instagram">Instagram</label>\n              <div class="input-wrapper">\n                <span class="material-icons-outlined">photo_camera</span>\n                <input type="url" id="link-instagram" name="instagram" placeholder="https://instagram.com/username">\n              </div>\n            </div>\n          </div>\n          \n          <div class="form-actions">\n            <div class="message" id="profile-message"></div>\n            <button type="submit" class="btn btn-primary">\n              <span class="material-icons-outlined">save</span>\n              <span>Save Changes</span>\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  `,async function(){try{const n=localStorage.getItem("username"),e=await fetch(`/api/user/profile?username=${encodeURIComponent(n)}&viewer=${encodeURIComponent(n)}`),t=await e.json();if(t.user){const n=document.getElementById("bio"),e=document.getElementById("bio-count"),a=document.getElementById("display-name"),i=document.getElementById("avatar-url"),o=document.getElementById("avatar-preview");if(n&&t.user.bio&&(n.value=t.user.bio,e.textContent=t.user.bio.length),a&&t.user.displayName&&(a.value=t.user.displayName),i&&t.user.avatar&&(i.value=t.user.avatar,s(t.user.avatar,o)),t.user.links){const n=t.user.links;n.website&&(document.getElementById("link-website").value=n.website),n.twitter&&(document.getElementById("link-twitter").value=n.twitter),n.github&&(document.getElementById("link-github").value=n.github),n.discord&&(document.getElementById("link-discord").value=n.discord),n.instagram&&(document.getElementById("link-instagram").value=n.instagram)}}}catch(n){console.error("Failed to load profile:",n)}}();const o=e.querySelector("#avatar-url"),r=e.querySelector("#avatar-preview");o.addEventListener("input",()=>{s(o.value,r)});const l=e.querySelector("#bio"),d=e.querySelector("#bio-count");l.addEventListener("input",()=>{d.textContent=l.value.length});const c=e.querySelector("#profile-form");c.addEventListener("submit",async e=>{e.preventDefault();const s=c.querySelector("#display-name").value.trim(),a=c.querySelector("#bio").value.trim(),i=c.querySelector("#avatar-url").value.trim(),o={website:c.querySelector("#link-website").value.trim(),twitter:c.querySelector("#link-twitter").value.trim(),github:c.querySelector("#link-github").value.trim(),discord:c.querySelector("#link-discord").value.trim(),instagram:c.querySelector("#link-instagram").value.trim()},r=c.querySelector("#profile-message"),l=c.querySelector('button[type="submit"]');if(!t([i,...Object.values(o)]))return r.textContent="Invalid URL detected. Only https:// URLs are allowed.",void(r.className="message error");l.disabled=!0,l.innerHTML='<span class="material-icons-outlined spinning">sync</span>';try{const e=await fetch("/api/user/profile",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:localStorage.getItem("username"),password:localStorage.getItem("password"),displayName:s,bio:a,avatar:i,links:o})}),t=await e.json();if(t.error)r.textContent=n(t.error),r.className="message error";else{r.textContent="Profile updated successfully!",r.className="message success",localStorage.setItem("displayName",s);const e=document.getElementById("profile-display-name");e&&(e.textContent=n(s));const t=document.querySelector(".user-display-name");t&&(t.textContent=n(s))}}catch(n){r.textContent="Connection error. Please try again.",r.className="message error"}l.disabled=!1,l.innerHTML='<span class="material-icons-outlined">save</span><span>Save Changes</span>',setTimeout(()=>{r.textContent="",r.className="message"},3e3)})},options:{title:"Profile",auth:!0,sidebar:!0}},"/settings":{render:function(){const n=document.getElementById("app");n.className="settings-page",localStorage.getItem("username"),n.innerHTML='\n    <div class="settings-container">\n      <div class="settings-header">\n        <h1>Settings</h1>\n        <p>Manage your account preferences</p>\n      </div>\n      \n      <div class="settings-content">\n        <div class="settings-section">\n          <div class="section-header">\n            <span class="material-icons-outlined">palette</span>\n            <h3>Appearance</h3>\n          </div>\n          \n          <div class="setting-item">\n            <div class="setting-info">\n              <span class="setting-title">Theme</span>\n              <span class="setting-description">Choose your preferred color scheme</span>\n            </div>\n            <div class="setting-control">\n              <select id="theme-select" class="select-input">\n                <option value="dark">Dark</option>\n                <option value="light">Light</option>\n                <option value="system">System</option>\n              </select>\n            </div>\n          </div>\n        </div>\n        \n        <div class="settings-section">\n          <div class="section-header">\n            <span class="material-icons-outlined">notifications</span>\n            <h3>Notifications</h3>\n          </div>\n          \n          <div class="setting-item">\n            <div class="setting-info">\n              <span class="setting-title">Push Notifications</span>\n              <span class="setting-description">Receive notifications about activity</span>\n            </div>\n            <div class="setting-control">\n              <label class="toggle">\n                <input type="checkbox" id="notifications-toggle" checked>\n                <span class="toggle-slider"></span>\n              </label>\n            </div>\n          </div>\n        </div>\n        \n        <div class="settings-section">\n          <div class="section-header">\n            <span class="material-icons-outlined">lock</span>\n            <h3>Privacy</h3>\n          </div>\n          \n          <div class="setting-item">\n            <div class="setting-info">\n              <span class="setting-title">Profile Visibility</span>\n              <span class="setting-description">Control who can see your profile</span>\n            </div>\n            <div class="setting-control">\n              <select id="privacy-select" class="select-input">\n                <option value="public">Public</option>\n                <option value="private">Private</option>\n              </select>\n            </div>\n          </div>\n        </div>\n        \n        <div class="settings-section">\n          <div class="section-header">\n            <span class="material-icons-outlined">security</span>\n            <h3>Security</h3>\n          </div>\n          \n          <div class="setting-item clickable" id="change-password-btn">\n            <div class="setting-info">\n              <span class="setting-title">Change Password</span>\n              <span class="setting-description">Update your account password</span>\n            </div>\n            <span class="material-icons-outlined">chevron_right</span>\n          </div>\n        </div>\n        \n        <div class="settings-section danger-section">\n          <div class="section-header">\n            <span class="material-icons-outlined">warning</span>\n            <h3>Danger Zone</h3>\n          </div>\n          \n          <div class="setting-item">\n            <div class="setting-info">\n              <span class="setting-title">Sign Out</span>\n              <span class="setting-description">Sign out of your account on this device</span>\n            </div>\n            <button class="btn btn-danger" id="logout-btn">\n              <span class="material-icons-outlined">logout</span>\n              <span>Sign Out</span>\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n    \n    <div class="modal" id="password-modal">\n      <div class="modal-backdrop"></div>\n      <div class="modal-content">\n        <div class="modal-header">\n          <h3>Change Password</h3>\n          <button class="modal-close" id="close-modal">\n            <span class="material-icons-outlined">close</span>\n          </button>\n        </div>\n        <form id="password-form">\n          <div class="form-group">\n            <label for="current-password">Current Password</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">lock</span>\n              <input type="password" id="current-password" required>\n            </div>\n          </div>\n          <div class="form-group">\n            <label for="new-password">New Password</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">lock</span>\n              <input type="password" id="new-password" required minlength="6">\n            </div>\n          </div>\n          <div class="form-group">\n            <label for="confirm-password">Confirm New Password</label>\n            <div class="input-wrapper">\n              <span class="material-icons-outlined">lock</span>\n              <input type="password" id="confirm-password" required>\n            </div>\n          </div>\n          <div class="message" id="password-message"></div>\n          <div class="modal-actions">\n            <button type="button" class="btn btn-secondary" id="cancel-modal">Cancel</button>\n            <button type="submit" class="btn btn-primary">Update Password</button>\n          </div>\n        </form>\n      </div>\n    </div>\n  ',async function(){try{const n=await fetch(`/api/user/profile?username=${encodeURIComponent(localStorage.getItem("username"))}`),e=await n.json();if(e.user?.settings){const{theme:n,notifications:t,privacy:s}=e.user.settings,a=document.getElementById("theme-select"),i=document.getElementById("notifications-toggle"),o=document.getElementById("privacy-select");a&&n&&(a.value=n),i&&(i.checked=!1!==t),o&&s&&(o.value=s)}}catch(n){console.error("Failed to load settings:",n)}}(),n.querySelector("#logout-btn").addEventListener("click",()=>{localStorage.removeItem("loggedIn"),localStorage.removeItem("username"),localStorage.removeItem("password"),localStorage.removeItem("displayName"),localStorage.removeItem("userId"),k("/auth")});const e=n.querySelector("#theme-select");e.addEventListener("change",()=>{a({theme:e.value})});const t=n.querySelector("#notifications-toggle");t.addEventListener("change",()=>{a({notifications:t.checked})});const s=n.querySelector("#privacy-select");s.addEventListener("change",()=>{a({privacy:s.value})});const i=n.querySelector("#password-modal"),o=n.querySelector("#change-password-btn"),r=n.querySelector("#close-modal"),l=n.querySelector("#cancel-modal"),d=i.querySelector(".modal-backdrop");o.addEventListener("click",()=>{i.classList.add("active")});const c=()=>{i.classList.remove("active"),i.querySelector("form").reset(),i.querySelector("#password-message").textContent=""};r.addEventListener("click",c),l.addEventListener("click",c),d.addEventListener("click",c);const p=n.querySelector("#password-form");p.addEventListener("submit",async n=>{n.preventDefault();const e=p.querySelector("#current-password").value,t=p.querySelector("#new-password").value,s=p.querySelector("#confirm-password").value,a=p.querySelector("#password-message"),i=p.querySelector('button[type="submit"]');if(t!==s)return a.textContent="Passwords do not match",void(a.className="message error");i.disabled=!0,i.innerHTML='<span class="material-icons-outlined spinning">sync</span>';try{const n=await fetch("/api/user/password",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:localStorage.getItem("username"),currentPassword:e,newPassword:t})}),s=await n.json();s.error?(a.textContent=s.error,a.className="message error"):(a.textContent="Password updated successfully!",a.className="message success",localStorage.setItem("password",t),setTimeout(()=>{c()},1500))}catch(n){a.textContent="Connection error. Please try again.",a.className="message error"}i.disabled=!1,i.innerHTML="Update Password"})},options:{title:"Settings",auth:!0,sidebar:!0}},"/404":{render:function(){const n=document.getElementById("app");n.className="notfound-page",n.innerHTML='\n    <div class="notfound-container">\n      <div class="notfound-content">\n        <span class="notfound-code">404</span>\n        <h1>Page Not Found</h1>\n        <p>The page you\'re looking for doesn\'t exist or has been moved.</p>\n        <a href="/dashboard" class="btn btn-primary">\n          <span class="material-icons-outlined">home</span>\n          <span>Back to Dashboard</span>\n        </a>\n      </div>\n    </div>\n  '},options:{title:"Not Found",sidebar:!1}}};function w(){const n=document.createElement("aside");n.id="sidebar",n.className="sidebar";const e=window.location.pathname;return n.innerHTML=`\n    <div class="sidebar-header">\n      <a href="/dashboard" class="sidebar-brand">\n        <span class="material-icons-outlined">bolt</span>\n        <span class="brand-text">Sodium</span>\n      </a>\n    </div>\n    \n    <nav class="sidebar-nav">\n      <ul class="nav-list" id="nav-list">\n        ${[{path:"/dashboard",icon:"dashboard",label:"Dashboard"},{path:"/servers",icon:"dns",label:"Servers"},{path:"/status",icon:"monitor_heart",label:"Status"},{path:"/profile",icon:"person",label:"Profile"},{path:"/settings",icon:"settings",label:"Settings"}].map(n=>`\n          <li class="nav-item">\n            <a href="${n.path}" class="nav-link ${e===n.path?"active":""}">\n              <span class="material-icons-outlined">${n.icon}</span>\n              <span class="nav-text">${n.label}</span>\n            </a>\n          </li>\n        `).join("")}\n      </ul>\n    </nav>\n    \n    <div class="sidebar-footer">\n      <div class="footer-content">\n        <span class="version">v1.0.0</span>\n      </div>\n    </div>\n  `,async function(n,e){const t=localStorage.getItem("username"),s=localStorage.getItem("password");if(t&&s)try{const a=await fetch(`/api/auth/me?username=${encodeURIComponent(t)}&password=${encodeURIComponent(s)}`),i=await a.json();if(i.user?.isAdmin){const t=n.querySelector("#nav-list"),s=t.querySelector('a[href="/settings"]')?.closest(".nav-item");if(s&&!t.querySelector('a[href="/admin"]')){const n=document.createElement("li");n.className="nav-item",n.innerHTML=`\n          <a href="/admin" class="nav-link ${"/admin"===e?"active":""}">\n            <span class="material-icons-outlined">admin_panel_settings</span>\n            <span class="nav-text">Admin</span>\n          </a>\n        `,t.insertBefore(n,s)}}}catch(n){console.error("Failed to check admin status:",n)}}(n,e),setTimeout(()=>{const e=()=>{window.innerWidth<=768&&n.classList.remove("open")};n.querySelectorAll(".nav-link").forEach(n=>{n.addEventListener("click",e)})},0),n}let S=!1,I=null;function $(n){if(n.defaultPrevented)return;if(0!==n.button||n.metaKey||n.ctrlKey||n.shiftKey||n.altKey)return;let e=n.target;for(;e&&"A"!==e.nodeName;)e=e.parentElement;if(!e)return;const t=e.getAttribute("href");!t||t.startsWith("http")||t.startsWith("mailto:")||t.startsWith("tel:")||(n.preventDefault(),k(t))}function k(n){n.startsWith("/")||(n=window.location.pathname.replace(/\/+$/,"")+"/"+n),window.history.pushState({},"",n),E()}function E(){const t=window.location.pathname;let s=f[t];if(!s&&t.startsWith("/u/")){const a=t.split("/")[2];a&&/^[a-zA-Z0-9_]{3,20}$/.test(a)&&(s=function(t){return{render:()=>function(t){const s=document.getElementById("app");s.className="user-page",s.innerHTML='\n    <div class="user-container">\n      <div class="loading-state">\n        <span class="material-icons-outlined spinning">sync</span>\n        <span>Loading profile...</span>\n      </div>\n    </div>\n  ',async function(t){const s=document.querySelector(".user-container"),a=localStorage.getItem("username")||"";try{const i=await fetch(`/api/user/profile?username=${encodeURIComponent(t)}&viewer=${encodeURIComponent(a)}`),o=await i.json();if(o.error)return void(s.innerHTML='\n        <div class="error-state">\n          <span class="material-icons-outlined">error</span>\n          <h2>User Not Found</h2>\n          <p>The user you\'re looking for doesn\'t exist.</p>\n          <a href="/dashboard" class="btn btn-primary">Back to Dashboard</a>\n        </div>\n      ');const r=o.user,l=r.isPrivate,d={website:"language",twitter:"alternate_email",github:"code",discord:"chat",instagram:"photo_camera"},c={website:"Website",twitter:"Twitter",github:"GitHub",discord:"Discord",instagram:"Instagram"};let p="";if(!l&&r.links){const t=Object.entries(r.links).filter(([n,e])=>e);t.length>0&&(p=`\n          <div class="user-links">\n            <h3>Links</h3>\n            <div class="links-list">\n              ${t.map(([t,s])=>{const a=e(s);return a?`\n                  <a href="${a}" target="_blank" rel="noopener noreferrer" class="link-item">\n                    <span class="material-icons-outlined">${d[t]||"link"}</span>\n                    <span>${n(c[t]||t)}</span>\n                    <span class="material-icons-outlined external">open_in_new</span>\n                  </a>\n                `:""}).join("")}\n            </div>\n          </div>\n        `)}const m=r.avatar?`<img src="${e(r.avatar)}" alt="Avatar" onerror="this.parentElement.innerHTML='<span class=\\'material-icons-outlined\\'>person</span>'">`:'<span class="material-icons-outlined">person</span>';s.innerHTML=`\n      <div class="user-profile-card">\n        <div class="user-header">\n          <div class="user-avatar">\n            ${m}\n          </div>\n          <div class="user-info">\n            <h1>${n(r.displayName||r.username)}</h1>\n            <span class="user-username">@${n(r.username)}</span>\n            ${l?'<span class="private-badge"><span class="material-icons-outlined">lock</span> Private Profile</span>':""}\n          </div>\n        </div>\n        \n        ${!l&&r.bio?`\n          <div class="user-bio">\n            <h3>About</h3>\n            <p>${n(r.bio)}</p>\n          </div>\n        `:""}\n        \n        ${l?'\n          <div class="private-notice">\n            <span class="material-icons-outlined">visibility_off</span>\n            <p>This profile is private</p>\n          </div>\n        ':""}\n        \n        ${p}\n        \n        ${!l&&r.createdAt?`\n          <div class="user-meta">\n            <span class="material-icons-outlined">calendar_today</span>\n            <span>Joined ${new Date(r.createdAt).toLocaleDateString("en-US",{month:"long",year:"numeric"})}</span>\n          </div>\n        `:""}\n      </div>\n    `}catch(n){s.innerHTML='\n      <div class="error-state">\n        <span class="material-icons-outlined">wifi_off</span>\n        <h2>Connection Error</h2>\n        <p>Unable to load profile. Please try again.</p>\n        <a href="/dashboard" class="btn btn-primary">Back to Dashboard</a>\n      </div>\n    '}}(t)}(t),options:{title:`${t}'s Profile`,sidebar:!0}}}(a))}if(!s&&t.startsWith("/server/")){const n=t.split("/")[2];n&&(s=function(n){return{render:()=>function(n){document.getElementById("app").innerHTML='\n    <div class="server-console-page">\n      <div class="page-header">\n        <a href="/servers" class="btn btn-ghost"><span class="material-icons-outlined">arrow_back</span> Back</a>\n        <h1 id="server-name">Loading...</h1>\n      </div>\n      \n      <div class="console-layout">\n        <div class="console-main">\n          <div class="card console-card">\n            <div class="console-header">\n              <h3>Console</h3>\n              <div class="power-buttons">\n                <button class="btn btn-success btn-sm" id="btn-start">Start</button>\n                <button class="btn btn-warning btn-sm" id="btn-restart">Restart</button>\n                <button class="btn btn-danger btn-sm" id="btn-stop">Stop</button>\n                <button class="btn btn-danger btn-sm" id="btn-kill">Kill</button>\n              </div>\n            </div>\n            <div class="console-output" id="console-output">\n              <div class="console-placeholder">Connecting to server...</div>\n            </div>\n            <div class="console-input">\n              <input type="text" id="command-input" placeholder="Type a command..." />\n              <button class="btn btn-primary" id="send-command">Send</button>\n            </div>\n          </div>\n        </div>\n        \n        <div class="console-sidebar">\n          <div class="card">\n            <h3>Resources</h3>\n            <div id="resources-display">\n              <div class="resource-item">\n                <span class="label">Status</span>\n                <span class="value" id="res-status">--</span>\n              </div>\n              <div class="resource-item">\n                <span class="label">CPU</span>\n                <span class="value" id="res-cpu">--</span>\n              </div>\n              <div class="resource-item">\n                <span class="label">Memory</span>\n                <span class="value" id="res-memory">--</span>\n              </div>\n              <div class="resource-item">\n                <span class="label">Disk</span>\n                <span class="value" id="res-disk">--</span>\n              </div>\n              <div class="resource-item">\n                <span class="label">Network ↑</span>\n                <span class="value" id="res-net-tx">--</span>\n              </div>\n              <div class="resource-item">\n                <span class="label">Network ↓</span>\n                <span class="value" id="res-net-rx">--</span>\n              </div>\n            </div>\n          </div>\n          \n          <div class="card">\n            <h3>Server Info</h3>\n            <div id="server-info">\n              <div class="info-item">\n                <span class="label">Address</span>\n                <span class="value" id="info-address">--</span>\n              </div>\n              <div class="info-item">\n                <span class="label">Node</span>\n                <span class="value" id="info-node">--</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  ',l(n),document.getElementById("btn-start").onclick=()=>d(n,"start"),document.getElementById("btn-restart").onclick=()=>d(n,"restart"),document.getElementById("btn-stop").onclick=()=>d(n,"stop"),document.getElementById("btn-kill").onclick=()=>d(n,"kill"),document.getElementById("send-command").onclick=()=>c(n),document.getElementById("command-input").onkeypress=e=>{"Enter"===e.key&&c(n)},r=setInterval(()=>l(n),5e3)}(n),cleanup:u,options:{title:"Console",auth:!0,sidebar:!0}}}(n))}s||(s=f["/404"]);const a=!!localStorage.getItem("loggedIn");if(s.redirect)return window.history.replaceState({},"",s.redirect),E();if(s.options?.auth&&!a)return window.history.replaceState({},"","/auth"),E();if(a&&"/auth"===t)return window.history.replaceState({},"","/dashboard"),E();if(a&&"/"===t)return window.history.replaceState({},"","/dashboard"),E();if(!a&&"/"===t)return window.history.replaceState({},"","/auth"),E();document.title="Sodium - "+(s.options?.title||"App");const i=document.getElementById("app");i&&i.classList.add("fade-out"),setTimeout(()=>{I&&(I(),I=null),function(n=!1){if(S){const e=document.getElementById("wrapper");if(e){e.className=n?"with-sidebar":"";const t=document.getElementById("sidebar");n&&!t?e.insertBefore(w(),e.firstChild):!n&&t&&t.remove()}}else{document.body.innerHTML="";const e=document.createElement("div");e.id="wrapper",e.className=n?"with-sidebar":"",n&&e.appendChild(w());const t=document.createElement("div");t.id="content-area",t.appendChild(function(){const n=document.createElement("nav");n.id="navbar",n.className="navbar";const e=localStorage.getItem("displayName")||localStorage.getItem("username")||"User",t=!!localStorage.getItem("loggedIn");return n.innerHTML=`\n    <div class="nav-content">\n      <div class="nav-left">\n        <button class="nav-toggle" id="sidebar-toggle">\n          <span class="material-icons-outlined">menu</span>\n        </button>\n        <a href="/dashboard" class="nav-brand">\n          <span class="material-icons-outlined">bolt</span>\n          <span class="brand-text">Sodium</span>\n        </a>\n      </div>\n      \n      <div class="nav-right">\n        ${t?`\n          <div class="user-menu" id="user-menu">\n            <button class="user-menu-btn" id="user-menu-btn">\n              <div class="user-avatar">\n                <span class="material-icons-outlined">person</span>\n              </div>\n              <span class="user-display-name">${e}</span>\n              <span class="material-icons-outlined dropdown-icon">expand_more</span>\n            </button>\n            <div class="user-dropdown" id="user-dropdown">\n              <a href="/profile" class="dropdown-item">\n                <span class="material-icons-outlined">person</span>\n                <span>Profile</span>\n              </a>\n              <a href="/settings" class="dropdown-item">\n                <span class="material-icons-outlined">settings</span>\n                <span>Settings</span>\n              </a>\n              <hr class="dropdown-divider">\n              <button class="dropdown-item logout" id="nav-logout">\n                <span class="material-icons-outlined">logout</span>\n                <span>Sign Out</span>\n              </button>\n            </div>\n          </div>\n        `:""}\n      </div>\n    </div>\n  `,setTimeout(()=>{const e=n.querySelector("#sidebar-toggle");e&&e.addEventListener("click",()=>{const n=document.getElementById("sidebar");n&&n.classList.toggle("open")});const t=n.querySelector("#user-menu-btn"),s=n.querySelector("#user-dropdown");t&&s&&(t.addEventListener("click",n=>{n.stopPropagation(),s.classList.toggle("active")}),document.addEventListener("click",()=>{s.classList.remove("active")}));const a=n.querySelector("#nav-logout");a&&a.addEventListener("click",()=>{localStorage.removeItem("loggedIn"),localStorage.removeItem("username"),localStorage.removeItem("password"),localStorage.removeItem("displayName"),localStorage.removeItem("userId"),k("/auth")})},0),n}());const s=document.createElement("main");s.id="app",t.appendChild(s),e.appendChild(t),document.body.appendChild(e),document.body.addEventListener("click",$),S=!0}}(!1!==s.options?.sidebar&&a),function(){const n=document.getElementById("app");n&&(n.innerHTML="")}();const n=document.getElementById("sidebar");n&&!1!==s.options?.sidebar&&a&&n.replaceWith(w()),s.render(),I=s.cleanup||null;const e=document.getElementById("app");e&&(e.classList.remove("fade-out"),e.classList.add("fade-in"))},150)}window.router={navigateTo:k},window.addEventListener("popstate",()=>{E()}),window.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("loading");setTimeout(()=>{n.classList.add("hidden"),n.addEventListener("transitionend",()=>{n.remove()}),E()},300)});